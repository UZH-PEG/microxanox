---
title: "m0.0.1: Microxanox - ..."
author:
- name: Rainer M Krug
  email: Rainer.Krug@uzh.ch & Rainer@krugs.de
  affiliation: University of Zürich
  footnote: Corresponding Author
- name: Owen L. Petchey
  email: Owen.Petchey@ieu.uzh.ch
  affiliation: University of Zürich
address:
- code: University of Zürich
  address: Department of Evolutionary Biology and Environmental Studies, Winterthurerstrasse
    190, 8057 Zurich
keywords: metadata quality; data curation; archival; long term storage; R package;
abstract: | 
  1. set the context for and purpose of the work;
  2. indicate the approach and methods;
  3. outline the main results;
  4. identify the conclusions and the wider implications.
journal: 'Ecology and Evolution - Applications'
bibliography: manuscript_bibliography.bib
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_float: true
  pdf_document:
    keep_tex: yes
header-includes:
- \usepackage{lineno}
- \linenumbers
- \usepackage{setspace}
- \doublespacing
- \usepackage{fancyhdr}
- \fancyhead{}
- \fancyfoot{}
- \fancyhead[CO,CE]{Metadata made easy - the dmdScheme approach}
- \pagestyle{fancy}

nocite: '@Bush2017'
linkcolor: blue
link-citations: yes
csl: methods-in-ecology-and-evolution.csl
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
```

# Introduction

{>> Biological justification and background - one paragraph <<}

The microxanox package is a package for simulating a three functional group system (*CB*: cyanobacteria, *PB*: phototrophic sulfur bacteria, and *SB*: sulfate-reducing bacteria) with four chemical substrates (*P*: phosphorus, *O*: oxygen, *SR*: reduced sulfur, *SO*: oxidized sulfur). It includes feddback between biogeochemical processes and is based on [@Bush2017] (See [@Bush2017] for a detailed discussion of the model).

The aims of the `microxanox` package are twofold. Firstly, the package aims at reproducing the results shown by [@Bush2017], which is acomplished in the [vignette Partial reproduction of Bush et al](LINK NEEDED). Secondly, to take these results one step further, it includes new functionality to adress our research question as presented in [@REF_NEEDED]. 

For this, we extended the model and added functionality for:

- Multiple strains (effectively unlimited) per functional group.
- Adding temporally varying oxygen diffusivity.
- Adding random noise in substrate concentrations.
- Including immigration.
- Setting minimum population abundances.

In addition to the model itself, the package includes some functions to analyse the results as well as visualise the results to provide a starting point for customised visualisations based on own requirements.

# The Model

The model is an implementation of the model described by [@Bush2017]. It is an ordinary differential equation (ODE) based numerical non-stochastic model which was implemented in form of an R package.

We use the notation from the [Table S1](LINK NEEDED) of the Supplementary information of [@Bush2017]), and not the notation in the main manuscript of [@Bush2017]. In the main manuscript the notation is simplified to `y_S_PB` ($y_{S,PB}$) (which is `y_SR_PB` ($y_{SR,PB}$) in Table S1) and `y_S_SB` ($y_{S,SB}$) (which is y_SO_SB ($y_{SO,SB}$) in Table S1). We also use `Pr_cB` ($Pr_B$) instead of `P_CB` ($P_{CB}$).

All parameter and variables follow these base dimensions:

- Time: `hours`
- Volume: `litres`
- Substrate quantity: `micromoles`
- Organism quantity: `cells`

{>> Add a more detailed description of the model and the additions <<}

The ODEs are solved using the "General Solver for Ordinary Differential Equations" of the `deSolve` package [@Soetaert2010].

## The ODEs
The ODEs for the rates of change are specified in the function `bushplus_dynamic_model()`. This augmented version of the model published in [@Bush2017] can handle multiple strains within each of the three functional groups, temporal variation in oxygen diffusivity, and events.
	
For an example how these can be used see [@REF_NEEDED] or the vignettes acompanying this package [@LINK_NEEDED]. 

# Availability and Accessability of the Package
The package is available in a [github repo/](https://github.com/UZH-PEG/microxanox/). The newest version is also available under the [DOI](https://DOI) or via RUniverse [@REF_NEEDED]. This manuscript describes version 1.0 which is available under [DOI](https://DOI) or installable within R by using `remotes::install_github("UZH-PEG", ref = "v1.0")`. 

The package will be updated based on further research activities. It will be tested continuously for the last recent, current and devel version of R. {>>If we wnat that, we havt o include some, even rudimentary, GITHUB tests.<<}

Issues, questions and suggestions should be communicated through the issue tracker at [https://github.com/UZH-PEG/microxanox/issues](https://github.com/UZH-PEG/microxanox/issues) 


# The Package
The package contains the full documentetion of the functions, which includes

1. Standard R help for each function (`?COMMAND` in R)
2. Two vignettes acompanying the package, also available under RUniverse [Vignette 1](@LINK_NEEDED) and [Vignette 2](@LINK_NEEDED)
3. This paper as a third vignette, also available under RUniverse [Vignette 3](@LINK_NEEDED)

We will discuss the general structure and functiuonalit of the package without going into to mu=ch detail.

The simulations can be split into different levels:

## The individuel simulation
The individual simulation (`run_simulation()` function) is the working horse in this package. In this function, the ODEs are solved. The function needs only one parameter - an object as created by the function `new_runsim_parameter()`. One parameter of this object is the `strain_parameter` which can be created by the function `new_strain_parameter()`. For a detailed description of the parameter and how they are created please see the User Guide and which acomnpanies the package or is available at [User Guide](@LINK_NEEDED)

After the paramter object has been defined, it can be used in the `run_simulation()` function. The function returns an object which is identical to the parameter, except of an additional slot containing the results. This design produces a fully reproducible object as it can be used instead of a parameter object to be fed back into the `run_simulation()` function to run the simulation again from the parameter used to generate the results from.

## Find a Steady State of the model
There are two methods for finding steady states. The first runs a separate simulation for each combination of starting conditions and oxygen diffusivity (let us term this the *Replication method*). The second runs only two simulations, with step-wise and slowly temporally increasing or decreasing oxygen diffusivities and recorded of state just before change to a new oxygen diffusivity (let us term this the *Temporal method*).

### Replication Method
The replication method is implementad in the function `run_replication_ssfind()` which takes a parameter object as returned by the function `new_replication_ssfind_parameter()` and the number of cores for multithreading the simulation.

### Temporal Method
The temporal method involves two simulations for a particular system configuration (parameter set). In one simulation the oxygen diffusivity is *increased* in a step-wise fashion. In the other it is *decreased* in a step-wise fashion. That is, oxygen diffusivity is held at a constant level for long enough for steady state to be reach, that state is recorded, and then a slightly higher (or lower) oxygen diffusivity value is set. Hence, at that time point, the system is effectively started with initial conditions that are the state of the system in the previous time step. We hereafter term this "the temporal method".
This is implemented in the function `run_temporal_ssfind()`, which takes a parameter object as created by the function `new_temporal_ssfind_parameter()` and a number indicating the .

For a more detailed walk-through of these two approaches and explanation please see the [User Guide](@LINK_NEEDED).

## Extract Stability Measures
From the raw results returned by these `run_...()` functions, the stability measures can be extracted by using the function `get_stability_measures()`. These measures include non-linearity and hysteresis measures, of the response of the simulated system to environmental change.

## Analysis and Graphing

The function `plot_dynamics()` plots a single simulation run, as returned from the `run_simulation()` function. This functio is only provided as a convenience function to provide a way to easily see the results of a simulation run. An example plot resulting from this function is shown in Figure 1.

![](./figures/fig1_plot_dynamics.png)

# Use cases
This package has been used in the production of the paper [@REF_NEEDED]. It can be used for similar studies in this study systems. It is not intended to provide a modelling framework which can be adjusted easily to all needs, but primarily a tool to implement the model used by [@Bush2017] and to extend it to our needs. Consequently, any more substantial, are likely to need a change in the source code.

Nevertheless, the model is structured in a way which builds on a modular structuere, so that e.g. the event definition can easily be changed. or other aspects can be adjusted. All values in the parameter object can be changed. 

# Conclusions



# References
