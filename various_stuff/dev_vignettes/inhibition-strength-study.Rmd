---
title: "Partial reproduction of Bush et al (2017) Oxic-anoxic regime shifts mediated by feedbacks between biogeochemical processes and microbial community dynamics"
author: "Owen Petchey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reproducing some results of Bush et al 2017}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r setup}
## Clear R
rm(list=ls())

## some chunk options
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)

## load required libraries
library(tidyverse)
library(deSolve)
library(rootSolve)
library(microxanox)

## Set random number generator seed
## Is redundant if there are no stochastic components in the model
set.seed(13)

## Should the rather lengthy simulations required to 
## construct the state-environment relationship
## be run?
run_steadystate_sims <- FALSE
```


# Introduction

The aims here are:

* Reproduce the results of [Bush et al 2017](https://www.nature.com/articles/s41467-017-00912-x).

Please see the User manual vignette for further introduction and general methods.

# Methods


### Default parameter values

```{r}
default_parameter_values <- c(
  
  ## maximum specific growth rates
  g_max_CB = 0.05,
  g_max_PB = 0.07,
  g_max_SB = 0.1,
  
  ## half-saturation constants
  k_PB_SR = 10,
  k_SB_SO = 5,
  k_CB_P = 0.2,
  k_PB_P = 0.5,
  k_SB_P = 0.5,
  
  ## half-inhibition constant
  h_SR_CB = 300,
  h_O_PB = 100,
  h_O_SB = 100,
  
  ## yield (cells per micromole)
  Y_SO_SB = 3.33e7,  
  Y_SR_PB = 1.25e7, ## Y_S_PB in the main text
  y_P_CB = 1.67e8,
  y_P_PB = 1.67e8,
  y_P_SB = 1.67e8,
  
  ## oxygen production per microbial cell
  P_CB = 6e-9,
  
  ## mortality rate
  m_CB = 0.02,
  m_PB = 0.028,
  m_SB = 0.04,
  
  ## substrate diffusivity
  a_S = 0.001,
  a_O = 8e-4,
  a_P = 0.01,
  
  ## background substrate concentration
  back_SR = 300,
  back_SO = 300,
  back_O = 300,
  back_P = 9.5,
  
  ## immigration rates (cells per time)
  i_CB <- 0,
  i_PB <- 0,
  i_SB <- 0,
  
  ## oxidisation rate of reduced sulphur
  c = 4e-5
  )
```

### Default event

#### Default event definition

Used to add noise and to ensure minimum abundance. Noise is added to the resource concentrations, and not to the organism abundances. Minimum organism abundance is set. I.e. organismal abundance cannot go below some very low level.

```{r}
source("functions/default_event_definition.r")
```

#### Default event schedule

This is when an event happens

```{r}
default_event_interval <- 10
```

#### Default noise event options

Default to no noise:

```{r}
default_noise_sigma <- 0
```

#### Default minimum abundance event

Default to following minimums

```{r}
default_minimum_abundances <- rep(1e2, 3)
names(default_minimum_abundances) <- c("CB", "PB", "SB") 
```



### Default simulation duration

```{r}
default_sim_duration <- 2000
default_sim_sample_interval <- 1
```

### Default oxygen diffusivity (a) forcing

Here we specify no forcing of a_0 (used unless set elsewhere).

```{r}
default_log10a_series <- c(log10(default_parameter_values["a_O"]),
                           log10(default_parameter_values["a_O"]))
```

### Default initial state

Initial conditions favouring anoxic.

```{r}
default_initial_state <- c(N_CB = 5e1,
           N_PB = 1e7,
           N_SB = 1e7,
           SO = 300,
           SR = 300,
           O = 1e1,
           P = 1e1)
```

## Simulation function

```{r}
source("functions/run_simulation.r")
```

## Helper functions

```{r}
source("functions/plot_dynamics.r")
source("functions/ss_expt_a_N.r")
source("functions/get_nonlinearity.r")
source("functions/get_hysteresis_range.r")
```



## Code test

```{r}
# dynamic_model = bushplus_dynamic_model
# event_definition = default_event_definition
# parameter_values = default_parameter_values
# event_interval = default_event_interval
# noise_sigma = default_noise_sigma
# minimum_abundances = default_minimum_abundances
# sim_duration = default_sim_duration
# sim_sample_interval = default_sim_sample_interval
# log10a_forcing = default_log10a_forcing
# initial_state = default_initial_state
# solver_method = "radau"
# 
# 
# times <- seq(0,
#              sim_duration,
#              by = sim_sample_interval)
# 
# event_times <- seq(min(times),
#                    max(times),
#                    by = event_interval)  
# 
# log10a_forcing <- approxfun(x = log10a_forcing[,1],
#                             y = log10a_forcing[,2],
#                             method = "linear",
#                             rule = 2)
# assign("log10a_forcing", log10a_forcing, envir = .GlobalEnv)
# 
# out <- as.data.frame(ode(y = initial_state,
#                          times = times,
#                          func = dynamic_model,
#                          parms = parameter_values,
#                          method = solver_method,
#                          events = list(func=event_definition,
#                                        time=event_times)))
# 
# sim_res <- run_simulation(dynamic_model = bushplus_dynamic_model,
#                            event_definition = default_event_definition,
#                            parameter_values = default_parameter_values,
#                            event_interval = default_event_interval,
#                            noise_sigma = default_noise_sigma,
#                            minimum_abundances = default_minimum_abundances,
#                            sim_duration = default_sim_duration,
#                            sim_sample_interval = default_sim_sample_interval,
#                            log10a_forcing = default_log10a_forcing,
#                            initial_state = default_initial_state,
#                            solver_method = "radau")

#sim_res <- run_simulation()

#plot_dynamics(sim_res)

```


# Results: Varying strength of inhibition

## Introduction

Three parameters set the strength of inhibition (half-inhibition constants):

* h_SR_CB = 300,
* h_O_PB = 100,
* h_O_SB = 100,

These work by the inhibition function:

$\frac{1}{1 + \frac{X}{h_X}}$

```{r}
inhibition
```


Plot some examples:

```{r}
default_parameter_values["h_SR_CB"]
SR <- 10^seq(1.4, 2.5, length = 100)
ggplot() +
  geom_line(aes(x = SR, y = inhibition(SR, default_parameter_values["h_SR_CB"]))) +
  ylab("Multiplicative effect\non CB growth rate")
```

```{r}
default_parameter_values["h_O_PB"]
O <- 10^seq(-0.2, 2.5, length = 100)
ggplot() +
  geom_line(aes(x = O, y = inhibition(O, default_parameter_values["h_O_PB"]))) +
  ylab("Multiplicative effect\non PB growth rate")
```

```{r}
default_parameter_values["h_O_SB"]
O <- 10^seq(-0.2, 2.5, length = 100)
ggplot() +
  geom_line(aes(x = O, y = inhibition(O, default_parameter_values["h_O_SB"]))) +
  ylab("Multiplicative effect\non SB growth rate")
```

```{r}
proportion_change <- 2
default_parameter_values["h_O_SB"]
O <- 10^seq(-0.2, 2.5, length = 100)
ggplot() +
  geom_line(aes(x = O, y = inhibition(O, proportion_change*default_parameter_values["h_O_SB"]))) +
  ylab("Multiplicative effect\non SB growth rate")
```



## Experiment

Increasing the inhibition half saturation constants weakens the inhibition.

```{r}
ssfind_minimum_abundances <- default_minimum_abundances
ssfind_simulation_duration <- 10000
ssfind_simulation_sampling_interval <- ssfind_simulation_duration
ssfind_event_interval <- ssfind_simulation_duration
ssfind_parameters <- default_parameter_values
ssfind_init_state <- c(N_CB = NA, #this one is varied
           N_PB = NA,
           N_SB = NA,
           SO = 200,
           SR = 200,
           O = 10,
           P = 9.5)

grid_num_mult <- 20
grid_num_N <- 2
grid_num_a <- 100

a_Os <- 10^seq(-4.5, -1.5, length=grid_num_a)
inhib_const_mults <- 2^seq(-1, 0.4, length=grid_num_mult)


initial_CBs <- 10^seq(0, 8, length=grid_num_N)
initial_PBs <- 1e5
initial_SBs <- 1e5

expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    inhib_const_mult = inhib_const_mults,
                    a_O = a_Os)
```


```{r eval = run_sims}
ss_h1 <- ss_by_a_h_N(expt)

saveRDS(ss_h1, "data/ss_h1.RDS")
```

```{r}
ss_h1 <- readRDS("data/ss_h1.RDS")
```


## Results

### Close to default inhibition

```{r}
inhib_const_mults
focal_inhibition_multiplier <- inhib_const_mults[14]

ss_h1 %>%
  filter(inhib_const_mult == focal_inhibition_multiplier) %>%
  select(a, N_CB, N_SB, N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


```{r}
ss_h1 %>%
  filter(inhib_const_mult == focal_inhibition_multiplier) %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


### Double strength inhibition

```{r}
## YES! 0.5 does mean twice as strong inhibition
focal_inhibition_multiplier <- 0.5

ss_h1 %>%
  filter(inhib_const_mult == focal_inhibition_multiplier) %>%
  select(a, N_CB, N_SB, N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


```{r}
ss_h1 %>%
  filter(inhib_const_mult == focal_inhibition_multiplier) %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


### Weaker inhibition

```{r}
## YES! 2 does mean half as strong inhibition
focal_inhibition_multiplier <- 2^0.4

ss_h1 %>%
  filter(inhib_const_mult == focal_inhibition_multiplier) %>%
  select(a, N_CB, N_SB, N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


```{r}
ss_h1 %>%
  filter(inhib_const_mult == focal_inhibition_multiplier) %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```




### Nonlinearity

```{r}
x_long <- ss_h1 %>%
  mutate(direction = ifelse(initial_N_CB==1, "up", "down")) %>%
  gather(key = Species, value = Quantity, 3:9) 
x_wide <- x_long %>%
  select(-initial_N_CB) %>%
  spread(key = direction, value=Quantity, drop=T)

resp_summary <- x_wide %>%
  group_by(inhib_const_mult, Species) %>%
  summarise(hyst_1 = mean(abs(log10(up) - log10(down))),
            hyst_2 = get_hysteresis_range(up, down, a),
            nl_up = get_nonlinearity(a, log10(up)),
            nl_down = get_nonlinearity(a, log10(down))) %>%
  ungroup() %>%
  gather(key = resp_measure, value = value, 3:6) %>%
  mutate(
         var_type = ifelse(str_sub(Species, 1, 1)=="N", "Organism", "Substrate")
         )
```


#### All species nonlinearity 

```{r}
resp_summ1 <- resp_summary %>%
  filter(resp_measure %in% c("nl_down", "nl_up")) %>%
  group_by(inhib_const_mult, Species, var_type) %>%
  summarise(ave_nl = mean(value))

resp_summ1 %>%
  ggplot() +
  geom_point(aes(inhib_const_mult, ave_nl)) +
  facet_wrap( ~ Species)

```

#### Substrate nonlinearity


```{r}
focus_on <- "Substrate"
ave_nl_substrate <- resp_summ1 %>%
  filter(var_type == focus_on) %>%
  group_by(inhib_const_mult) %>%
  summarise(ave_ave_nl = mean(ave_nl))
ave_nl_substrate %>%
  ggplot() +
  geom_point(aes(inhib_const_mult, ave_ave_nl)) +
  ggtitle(paste("Nonlinearity in", focus_on, "response."))
```

#### Organism nonlinearity


```{r}
focus_on <- "Organism"
ave_nl_organism <- resp_summ1 %>%
  filter(var_type == focus_on) %>%
  group_by(inhib_const_mult) %>%
  summarise(ave_ave_nl = mean(ave_nl))
ave_nl_organism %>%
  ggplot() +
  geom_point(aes(inhib_const_mult, ave_ave_nl)) +
  ggtitle(paste("Nonlinearity in", focus_on, "response."))
```

#### System nonlinearity

```{r}
focus_on <- "System"
ave_nl_system <- resp_summ1 %>%
  group_by(inhib_const_mult) %>%
  summarise(ave_ave_nl = mean(ave_nl))
ave_nl_system %>%
  ggplot() +
  geom_point(aes(inhib_const_mult, ave_ave_nl)) +
  ggtitle(paste("Nonlinearity in", focus_on, "response."))
ggsave("figures/system_nonlinearity.png", width = 3, height = 2)

```

### Hysteresis

#### Substrate hysteresis 

```{r}
focus_on <- "Substrate"
resp_summ3 <- resp_summary %>%
  filter(resp_measure %in% c("hyst_1", "hyst_2"),
         var_type == focus_on) %>%
  group_by(inhib_const_mult, resp_measure, var_type) %>%
  summarise(ave_hyst = mean(value))

resp_summ3 %>%
  ggplot() +
  geom_point(aes(x = inhib_const_mult, y = ave_hyst)) +
  facet_wrap( ~ resp_measure, scales="free") +
  ggtitle(paste("Hysteresis in", focus_on, "response."))

```

#### Organism hysteresis 

```{r}
focus_on <- "Organism"
resp_summ3 <- resp_summary %>%
  filter(resp_measure %in% c("hyst_1", "hyst_2"),
         var_type == focus_on) %>%
  group_by(inhib_const_mult,  resp_measure, var_type) %>%
  summarise(ave_hyst = mean(value))

resp_summ3 %>%
  ggplot() +
  geom_point(aes(x = inhib_const_mult, y = ave_hyst)) +
  facet_wrap( ~ resp_measure, scales="free") +
  ggtitle(paste("Hysteresis in", focus_on, "response."))

```

#### System hysteresis (separate)

```{r}
resp_summ4 <- resp_summary %>%
  filter(resp_measure %in% c("hyst_1", "hyst_2")) %>%
  group_by(resp_measure, inhib_const_mult) %>%
  summarise(mean_hyst = mean(value))

resp_summ4 %>%
  ggplot() +
  geom_point(aes(x = inhib_const_mult, y = mean_hyst)) +
  facet_wrap( ~ resp_measure) +
  ggtitle("Hysteresis in system response.")

```

#### System hysteresis (combined)


```{r}
resp_summ5 <- resp_summ4 %>%
  group_by(inhib_const_mult) %>%
  summarise(mean_mean_hyst = mean(mean_hyst))

resp_summ5 %>%
  ggplot() +
  geom_point(aes(x = inhib_const_mult, y = mean_mean_hyst)) +
  xlab("Organismal tolerance") +
  ylab("Amount of hysteresis") +
  theme_light() +
  ylim(0,2)
ggsave("figures/inhibition_system_hysteresis.png", width = 2.5, height = 2)

```






# Appendices

Rainer: don't change what comes below


## runsteady function not finding correct values

```{r eval = FALSE}

init_state_anoxic_2 <- c(N_CB = 1e1,
           N_PB = 1e8,
           N_SB = 1e8,
           SO = 300,
           SR = 300,
           O = 1e-5,
           P = 1e1)


RS <- runsteady(y = init_state_anoxic_2,
                fun = bushplus_dynamic_model,
                parms = default_parameter_values,
                times = c(0, 1e5),
                stol=1)
RS$y
RS <- runsteady(y = init_state_favouring_oxic,
                fun = bushplus_dynamic_model,
                parms = default_parameter_values,
                times = c(0, 1e5),
                stol=1)
RS$y

```

## Separatrix

Note that this section not working / updated since the code was made into functions

### Effect of N_CB and oxygen diffusability

```{r eval = FALSE}

noise_sigma <- 0.0

get_final_states_N_CB <- function(x) { 
  
  #give N_CB, N_SB, N_PB and a_O values and put these into state and parameters
  state["N_CB"] <- x["N_CB"]
  parameters["a_O"] <- x["a_O"]
  
  ## update forcing function
  a_forcing1 <- matrix(ncol=2, byrow=T, data=c(0,
                                             log10(parameters["a_O"]),
                                             max(times),
                                             log10(parameters["a_O"])))
  log10a_forcing2 <- approxfun(x = a_forcing1[,1],
                             y = a_forcing1[,2],
                             method = "linear",
                             rule = 2)
  
  ## assign the changed a_forcing2 into the global environment, from where the model gets a_forcing2
  assign("log10a_forcing2", log10a_forcing2, envir = .GlobalEnv)

  as.data.frame(ode(y = state,
                    times = times,
                    func = micro_mod_var,
                    parms = parameters,
                    method = "radau",
                    events = list(func=noise_events, time=times)))[2,-1] 
  #gives you values for the last time step
}

times <- seq(0, 50000, by = 50000)

state <- c(N_CB = NA, #this one is varied
           N_PB = 1e8,
           N_SB = 1e8,
           SO = 200,
           SR = 200,
           O = 10,
           P = 9.5)

#different combinations of N_CB and oxygen diffusability
grid_num <- 50
expt <- expand.grid(N_CB = 10^seq(0, 8, length=grid_num),
                    a_O = 10^seq(-3.5, -2, length=grid_num))


result <- apply(expt, 1, function(x) get_final_states_N_CB(x)) %>%
                          tibble() %>%
                          unnest() %>%
                          mutate(initial_N_CB=expt$N_CB,
                                 a_O=expt$a_O,
                                 highlow=ifelse(N_CB>2e8, 'high', 'low'))

result <- result %>%
  mutate(N_CB = ifelse(N_CB < minimum_abundance, minimum_abundance, N_CB))



result$highlow <- as.factor(result$highlow)
saveRDS(result, "data/CB_oxdiff_hyst.RDS")
```

```{r eval = FALSE}
result <- readRDS("data/CB_oxdiff_hyst.RDS")
```



```{r eval = FALSE}

#plot N_CB / P_CB against a_0
p <- ggplot(result) + 
  geom_line(aes(x=log10(a_O), y=log10(N_CB), color=highlow), size=1.25) +
  ggtitle("Stable states of the system")+
  xlab('log[oxygen diffusivity]') +
  ylab('Initial cyanobacteria abundance')
p <- p + geom_point(data=result, aes(x=log10(a_O), y=log10(initial_N_CB), color=highlow)) + labs(color = "Final CB concentration")
plot(p)
#ggsave("initial conditions_1.png")
```



```{r eval = FALSE}
#show hysterisis effects for all the parameters
#plot oxygen against diffusability
ggplot(result) + 
  geom_point(aes(x=log10(a_O), y=(log10(O))))+
  xlab('log[oxygen diffusivity]') +
  ylab('log[oxygen concentration]')+
  geom_segment(aes(x=log10(result$a_O[839]), y=log10(result$O[839]), xend=log10(result$a_O[838]), yend=log10(result$O[838])), arrow=arrow(), colour="blue", size=0.5)+
  geom_segment(aes(x=log10(result$a_O[1761]), y=log10(result$O[1761]), xend=log10(result$a_O[1762]), yend=log10(result$O[1762])), arrow=arrow(), colour="blue", size=0.5)+
  geom_segment(aes(x=-4.25, y=-0.45, xend=-3.75, yend=0.1), arrow=arrow(), colour="blue", size=0.5)+
  geom_curve(aes(x = -3.75, y = 1.9, xend = -4.25, yend = 1.5), arrow=arrow(), colour='blue', size = 0.5, curvature = -0.2)
#ggsave("hysterisis_CB_1.png")
```

```{r eval = FALSE}
ggplot(result) + 
  geom_point(aes(x=log10(a_O), y=(log10(P))))+
  ggtitle("Hysterisis effect of phoshate concentration")+
  xlab('log[oxygen diffusivity]') +
  ylab('log[phosphate concentration]')
#ggsave("hysterisis_CB_2.png")
```

```{r eval = FALSE}
ggplot(result) + 
  geom_point(aes(x=log10(a_O), y=(log10(SO))))+
  ggtitle("Hysterisis effect of oxidized sulfur concentration")+
  xlab('log[oxygen diffusivity]') +
  ylab('log[oxydized sulfur concentration]')
#ggsave("hysterisis_CB_3.png")
```

```{r eval = FALSE}
ggplot(result) + 
  geom_point(aes(x=log10(a_O), y=(log10(SR))))+
  ggtitle("Hysterisis effect of reduced sulfur concentration")+
  xlab('log[oxygen diffusivity]') +
  ylab('log[reduced sulfur] concentration]')
#ggsave("hysterisis_CB_4.png")
```

These graphs show an at least qualitative match to the result in the paper.


### Effect of PB/SB depending on oxygen diffusability


```{r eval = FALSE}
noise_sigma <- 0.00
get_final_states_N_PB <- function(x) { 
  #give in N_CB, N_SB, N_PB and a_O values and put these into state and parameters
  state["N_PB"] <- x["var"]
  state["N_SB"] <- x["var"]
  parameters["a_O"] <- x["a_O"]
  
  ## update forcing function
  a_forcing1 <- matrix(ncol=2, byrow=T, data=c(0,
                                             log10(parameters["a_O"]),
                                             max(times),
                                             log10(parameters["a_O"])))
  log10a_forcing2 <- approxfun(x = a_forcing1[,1],
                             y = a_forcing1[,2],
                             method = "linear",
                             rule = 2)
  ## assign the changed a_forcing2 into the global environment, from where the model gets a_forcing2
  assign("log10a_forcing2", log10a_forcing2, envir = .GlobalEnv)
  
  as.data.frame(ode(y = state,
                         times = times,
                         func = micro_mod_var,
                         parms = parameters,
                         method = "radau", events = list(func=noise_events, time=times)))[2,-1] 
  #gives you values for the last time step
}

times <- seq(0, 50000, by = 5000)
state <- c(N_CB = 5, 
           N_PB = NA,#this one is varied
           N_SB = NA,
           SO = 200,
           SR = 200,
           O = 10,
           P = 9.5)

#different combinations of N_PB and oxygen diffusivity
grid_num <- 50
expt <- expand.grid(var=10^seq(0, 7, length=grid_num),
                    a_O = 10^seq(-3, -2, length=grid_num))


result2 <- apply(expt, 1, function(x) get_final_states_N_PB(x)) %>%
                          tibble() %>%
                          unnest() %>%
                          mutate(initial_N_PB=expt$var,
                                 initial_N_SB=expt$var,
                                 a_O=expt$a_O,
                                 highlow=ifelse(N_PB>1e8, 'high', 'low')) 

result2 <- result2 %>%
  mutate(N_PB = ifelse(N_PB < minimum_abundance, minimum_abundance, N_PB))

result2$highlow <- as.factor(result2$highlow)
saveRDS(result2, "data/PBSB_oxdiff_hyst.RDS")
```

```{r eval = FALSE}
result2 <- readRDS("data/PBSB_oxdiff_hyst.RDS")
```


```{r eval = FALSE}
#plot N_PB against a_0
p <- ggplot(result2) + 
  geom_line(aes(x=log10(a_O), y=log10(N_PB), color=highlow), size=1.25) +
  ggtitle("Stable states of the system")+
  xlab('log[oxygen diffusivity]') +
  ylab('Initial PS and SR bacteria concentration')
p <- p + geom_point(data=result2,
                    aes(x=log10(a_O), y=log10(initial_N_PB), color=highlow))
p <- p + labs(color = "Final PB and SB concentration")
plot(p)
#ggsave("initial conditions_2.png")
```




