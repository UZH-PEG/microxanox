---
title: "User guide -- microxanox R Package for microbial oxic and anoxic ecosystem simulations"
author: "Owen Petchey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{User guide -- microxanox R Package for microbial oxic and anoxic ecosystem simulations}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo = FALSE, output = FALSE, message = FALSE}

knitr::opts_chunk$set(cache = FALSE,
                      fig.align = "centre", fig.width = 7, fig.height = 7)


library(tidyverse)
library(deSolve)
library(rootSolve)
library(here)
if (!require(microxanox)) {
  devtools::load_all(here::here())
}
library(patchwork)

## Set random number generator seed
## Is redundant if there are no stochastic components in the model
set.seed(13)

run_steadystate_sims <- TRUE
```


```{r echo = TRUE}
library(microxanox)
```


# Introduction

The aims of the `microxanox` package are:

* Facilitate reproduction of the results of [Bush et al 2017](https://www.nature.com/articles/s41467-017-00912-x).
* Include new functionality that allows new research questions to be answered.

We added functionality for:

* Adding random noise in substrate concentrations.
* Adding temporally vary oxygen diffusivity.
* Including immigration.
* Setting minimum population abundances
* Changing organismal tolerances to environmental conditions.
* Changing the number of strains per functional group. 

Here (again) is the original publication:
https://www.nature.com/articles/s41467-017-00912-x

And here is the supplementary information, including the table of parameter values:
https://static-content.springer.com/esm/art%3A10.1038%2Fs41467-017-00912-x/MediaObjects/41467_2017_912_MOESM1_ESM.pdf

Note that in this package we use the notation from the table S1 of the supplementary information, and not the notation in the main text. (There is only one small difference between these: In the main text the notation is simplified to y_S_PB (which is y_SR_PB ($y_{SR,PB}$) in Table S1) and y_S_SB (which is y_SO_SB ($y_{SO,SB}$) in Table S1). We also use $Pr_cB$  instead of $P_CB$.

## Model dimensions

* Time: hours
* Volume: litres
* Substrate quantity: micromoles
* Organism quantity: cells

# Modelling framework

The framework used for running a simulation, and for varying aspects of a simulation run is:

* Define the default simulation conditions.
* Use these defaults unless other conditions are specified.
* The function call `run_simulation()` would therefore run a simulation with default conditions.
* The function call `run_simulation(initial_state = init_state_favouring_anoxic)` would run the simulation with the specified initial state values, and otherwise all the specified defaults.

# Conditions that must be defined

Conditions that must be set, with an example of setting them:

## The dynamic model

The ordinary differential equations for the rates of change are specified in the function `bushplus_dynamic_model()`. This augmented version of the model published in Bush et al 2017 can handle multiple strains within each of the three functional groups.

```{r}
default_dynamic_model <- bushplus_dynamic_model_strains
```

## The parameter and initial state values

The parameter values and initial state values are held in one object. The function `new_strain_starter` can be used to create this object. In the follow, we specify one strain per functional group, all parameter values as defined in Bush et al 2017, and starting conditions as the anoxic favouring conditions in Bush et al.

```{r}

bush_anoxicstart_1strain <- new_strain_starter(n_CB = 1,
                                               values_CB = "bush",
                                               n_PB = 1,
                                               values_PB = "bush",
                                               n_SB = 1,
                                               values_SB = "bush",
                                               values_other = "bush",
                                               values_initial_state = "bush_anoxic")

```

Here are the parameter values of the CB strain, for example

```{r}
bush_anoxicstart_1strain$CB
```

And here are the initial state values:

```{r}
bush_anoxicstart_1strain$initial_state
```


## The duration of the simulation:

```{r}
default_sim_duration <- 2000
```

## The sampling interval:

```{r}
default_sim_sample_interval <- 1
```

## The oxygen diffusivity dynamics

Specified by giving a vector of values of $a_0$. These are then automatically spaced equally along the duration of the simulation. Here we specify no forcing of $a_0$.

```{r}
default_log10a_series <- c(log10(bush_anoxicstart_1strain$a_O),
                           log10(bush_anoxicstart_1strain$a_O))
```

Note that here we use the already set default value of $a_0$ and therefore must have already defined the default parameter values.

## Events

These are "things" that happen during the simulation. One has to specify what happens, and when it happens.

#### What happens

The event definition function currently available can add noise to a state variable, and/or assure minimum abundance is not exceeded:

```{r}
default_event_definition <- event_definition_1_strains
```

#### Default event interval

Here set to an event every 10 time units.

```{r}
default_event_interval <- 10
```

#### Default noise event options

Default to no noise added to substrate concentrations:

```{r}
default_noise_sigma <- 0
```

#### Default minimum abundance event

Default to following minimum abundances:

```{r}
default_minimum_abundances <- rep(1e2, 3)
names(default_minimum_abundances) <- c("CB", "PB", "SB") 
```

# Warning: Assignment to global environment

Please note that the following objects are created during simulations and are assign to the global environment:

* `log10a_forcing_func`
* `noise_sigma`
* `minimum_abundances`

# Run some example simulations

## 1 strain anoxic start

Once all the conditions are assigned to the default objects, then the `run_simulation` function will use them without being explicitly given them, though still here we pass the parameter values and the initial states:

```{r eval = run_steadystate_sims}
anoxic_start_sim_results <- run_simulation(parameter_values = bush_anoxicstart_1strain,
                                      initial_state = bush_anoxicstart_1strain$initial_state)
```


```{r eval = run_steadystate_sims, echo = FALSE}
saveRDS(anoxic_start_sim_results, file = "data/user_guide/anoxic_start_sim_results.RDS")
```

The convenience function `plot_dynamics_strains` can be used to easily visualise the dynamics of a simulation:

```{r echo = FALSE}
anoxic_start_sim_results <- readRDS(file = "data/user_guide/anoxic_start_sim_results.RDS")
```


```{r}
plot_dynamics_strains(anoxic_start_sim_results)
```


# 1 strain oxic start

```{r}
bush_oxicstart_1strain <- new_strain_starter(values_initial_state = "bush_oxic")
```

```{r eval = run_steadystate_sims}
oxic_start_sim_results <- run_simulation(parameter_values = bush_oxicstart_1strain,
                                      initial_state = bush_oxicstart_1strain$initial_state)
```

```{r eval = run_steadystate_sims, echo = FALSE}
saveRDS(oxic_start_sim_results, file = "data/user_guide/oxic_start_sim_results.RDS")
```


```{r echo = FALSE}
oxic_start_sim_results <- readRDS(file = "data/user_guide/oxic_start_sim_results.RDS")
```


```{r}
plot_dynamics_strains(oxic_start_sim_results)
```




## Three strains per functional group

```{r}
multi_strain_paramameter <- new_strain_starter(n_CB = 3,
                                               n_PB = 3,
                                               n_SB = 3)
```

For example, here are the parameters of the three CB strains:

```{r}
multi_strain_paramameter$CB
```

And the initial state values

```{r}
multi_strain_paramameter$initial_state
```


So we can see the different strains, we now give them slightly different initial abundances:


```{r}
#multi_strain_paramameter$initial_state <- new_initial_state(n_CB = 3, n_PB = 3, n_SB = 3, values = "bush_anoxic")

multi_strain_paramameter$initial_state["CB_1"] <- 5e3
multi_strain_paramameter$initial_state["CB_2"] <- 1e3
multi_strain_paramameter$initial_state["CB_3"] <- 0
multi_strain_paramameter$initial_state["PB_1"] <- 1e7
multi_strain_paramameter$initial_state["PB_2"] <- 1e6
multi_strain_paramameter$initial_state["PB_3"] <- 1e5
multi_strain_paramameter$initial_state["SB_1"] <- 1e7
multi_strain_paramameter$initial_state["SB_2"] <- 1e6
multi_strain_paramameter$initial_state["SB_3"] <- 1e5
#multi_strain_paramameter$initial_state["SO"] <- 300
#multi_strain_paramameter$initial_state["SR"] <- 300
#multi_strain_paramameter$initial_state["O"] <- 1e1
#multi_strain_paramameter$initial_state["P"] <- 1e1
```


```{r eval = run_steadystate_sims}
simulation_result3 <- run_simulation(
  parameter_values = multi_strain_paramameter,
  initial_state = multi_strain_paramameter$initial_state
)
saveRDS(simulation_result3, file = "data/user_guide/multistrain3.RDS")
```


```{r}
simulation_result3 <- readRDS(file = "data/user_guide/multistrain3.RDS")
plot_dynamics_strains(simulation_result3)
```


