---
title: "User guide -- microxanox R Package for microbial oxic and anoxic ecosystem simulations"
author: "Owen Petchey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{User guide -- microxanox R Package for microbial oxic and anoxic ecosystem simulations}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo = FALSE, output = FALSE, message = FALSE}

knitr::opts_chunk$set(cache = FALSE,
                      fig.align = "centre", fig.width = 7, fig.height = 7)


library(tidyverse)
library(deSolve)
library(rootSolve)
library(here)
library(microxanox)
library(patchwork)
```


```{r echo = TRUE}
library(microxanox)
```


# Introduction

The aims of the `microxanox` package are:

* Facilitate reproduction of the results of [Bush et al 2017](https://www.nature.com/articles/s41467-017-00912-x).
* Include new functionality that allows new research questions to be answered.

We added functionality for:

* adding random noise in substrate concentrations.
* adding temporally vary oxygen diffusivity.
* including immigration.
* setting minimum population abundances
* changing organismal tolerances to environmental conditions.
* Changing the number of strains per functional group. 

Here we use only the published (Bush et al 2017) dynamical model, in which there is not biodiversity within each of the three functional groups. That is, there is only one parameter set per functional group. Please see the vignette for multi-strain simulations for information about implementing those.

Here (again) is the original publication:
https://www.nature.com/articles/s41467-017-00912-x

And here is the supplementary information, including the table of parameter values:
https://static-content.springer.com/esm/art%3A10.1038%2Fs41467-017-00912-x/MediaObjects/41467_2017_912_MOESM1_ESM.pdf

Note that om this package we use the notation from the table S1 of the supplementary information, and not the notation in the main text. (There is only one small difference between these: In the main text the notation is simplified to y_S_PB (which is y_SR_PB ($y_{SR,PB}$) in Table S1) and y_S_SB (which is y_SO_SB ($y_{SO,SB}$) in Table S1).

## Model dimensions

* Time: hours
* Volume: litres
* Substrate quantity: micromoles
* Organism quantity: cells

# Modelling framework

The framework used for running a simulation, and for varying aspects of a simulation run is:

* Define the default simulation conditions.
* Use these defaults unless other conditions are specified.
* The function call `run_simulation()` would therefore run a simulation with default conditions.
* The function call `run_simulation(initial_state = init_state_favouring_anoxic)` would run the simulation with the specified initial state values.

# Defaults

Automatic defaults (i.e. will apply as soon as package is loaded):

* dynamic_model = bushplus_dynamic_model (a function)
* event_definition = default_event_definition (a function)
* solver_method = "radau"

Defaults that must be set:

* parameter_values = default_parameter_values
* initial_state = default_initial_state
* event_interval = default_event_interval
* noise_sigma = default_noise_sigma
* minimum_abundances = default_minimum_abundances
* sim_duration = default_sim_duration
* sim_sample_interval = default_sim_sample_interval
* log10a_series = default_log10a_series

Each is now described and, if required, given a value.

## Default dynamic model

The ordinary differential equations for the rates of change are specified in the function `bushplus_dynamic_model_strains()`. This is an augmented version that can handle multiple strains within each of the three functional groups. The basic version that has only one strain per functional group is `bushplus_dynamic_model()`. The multiple strain version will run with one strain per functional group, and then gives the same results as the basic version. The multiple strain versions is, however, quite a bit slower, even for one strain.

Here we define the default dynamic model to be the basic, one strain per functional group version.

```{r}
default_dynamic_model <- bushplus_dynamic_model
```

## Default parameter values

Only one set of parameter values is used throughout. It gives the possibility for alternate stable states.

```{r}
default_parameter_values <- return_default_parameter_values()
```

## Default initial state

Specify the default set of initial conditions (here favouring anoxic organisms).

```{r}
default_initial_state <- return_default_initial_state()
```

## Default simulation duration

Default to the following duration and interval between samples:

```{r}
default_sim_duration <- 2000
default_sim_sample_interval <- 1
```

## Default oxygen diffusivity (a) forcing

Specified by giving a vector of values of $a_0$. These are then automatically spaced equally along the duration of the simulation. Here we specify no forcing of $a_0$.

```{r}
default_log10a_series <- c(log10(default_parameter_values["a_O"]),
                           log10(default_parameter_values["a_O"]))
```


## Default event

#### Default event definition

Default is to ensure abundances are not below minimum, and to add the amount of noise specified below (none in this vignette).

This default functionality is in the function `default_event_definition()`

#### Default event interval

Here set to an event every 10 time steps.

```{r}
default_event_interval <- 10
```

#### Default noise event options

Default to no noise added to substrate concentrations:

```{r}
default_noise_sigma <- 0
```

#### Default minimum abundance event

Default to following minimum abundances:

```{r}
default_minimum_abundances <- rep(1e2, 3)
names(default_minimum_abundances) <- c("CB", "PB", "SB") 
```

# Run a simulation

```{r}
default_sim_results <- run_simulation()
```

# Plot the results of a simulation

```{r}
plot_dynamics(default_sim_results)
```

# Run simulation with different defaults

```{r}
initial_state_favouring_oxic <- c(N_CB = 1e7,
           N_PB = 1e5,
           N_SB = 1e5,
           SO = 500,
           SR = 50,
           O = 30,
           P = 10)

new_sim_results <- run_simulation(initial_state = initial_state_favouring_oxic)
plot_dynamics(new_sim_results)
```



# Appendix

The code below was useful for debugging.

```{r eval = FALSE}
dynamic_model = bushplus_dynamic_model
event_definition = default_event_definition
parameter_values = default_parameter_values
event_interval = default_event_interval
noise_sigma = default_noise_sigma
minimum_abundances = default_minimum_abundances
sim_duration = default_sim_duration
sim_sample_interval = default_sim_sample_interval
log10a_series = default_log10a_series
initial_state = default_initial_state
solver_method = "radau"

times <- seq(0,
             sim_duration,
             by = sim_sample_interval)

event_times <- seq(min(times),
                   max(times),
                   by = event_interval)

log10a_forcing <- matrix(ncol=2,
                         byrow=F,
                         data=c(ceiling(seq(0,
                                            max(times),
                                            length=length(log10a_series))),
                                log10a_series))


log10a_forcing <- approxfun(x = log10a_forcing[,1],
                            y = log10a_forcing[,2],
                            method = "linear",
                            rule = 2)
assign("log10a_forcing_func", log10a_forcing, envir = .GlobalEnv)

out <- as.data.frame(ode(y = initial_state,
                         times = times,
                         func = dynamic_model,
                         parms = parameter_values,
                         method = solver_method,
                         events = list(func=event_definition,
                                       time=event_times)))

bushplus_dynamic_model(1, initial_state, default_parameter_values)

sim_res <- run_simulation(dynamic_model = bushplus_dynamic_model,
                           event_definition = default_event_definition,
                           parameter_values = default_parameter_values,
                           event_interval = default_event_interval,
                           noise_sigma = default_noise_sigma,
                           minimum_abundances = default_minimum_abundances,
                           sim_duration = default_sim_duration,
                           sim_sample_interval = default_sim_sample_interval,
                           log10a_series = default_log10a_series,
                           initial_state = default_initial_state,
                           solver_method = "radau")

sim_res <- run_simulation(dynamic_model = bushplus_dynamic_model)

plot_dynamics(sim_res)

```




