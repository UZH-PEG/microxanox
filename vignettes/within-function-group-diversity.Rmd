---
title: A study of the effects of within functional group diversity on the response
  to environmental change.
author: "Owen Petchey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Effects of within functional group diversity}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


# Setup R

```{r setup}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE, cache = FALSE,
                      fig.align = "centre", fig.width = 7, fig.height = 7)

library(tidyverse)
library(deSolve)
library(rootSolve)
library(here)
if (!require(microxanox)) {
  devtools::load_all(here::here())
}

## Set random number generator seed
## Is redundant if there are no stochastic components in the model
set.seed(13)

run_steadystate_sims <- TRUE
```


# Introduction

The aims here are:

* Reproduce the results of [Bush et al 2017](https://www.nature.com/articles/s41467-017-00912-x).

Please see the User manual vignette for further introduction and general methods.

# Methods

## Set defaults

```{r}
default_dynamic_model <- bushplus_dynamic_model_strains
## no default_parameter_values
## no default_initial_state
default_sim_duration <- 2000
default_sim_sample_interval <- 1
default_log10a_series <- c(log10(new_strain_parameter()[["a_O"]]),
                           log10(new_strain_parameter()[["a_O"]]))
default_event_definition <- event_definition_1_strains
default_event_interval <- 10
default_noise_sigma <- 0
default_minimum_abundances <- rep(1e2, 3)
names(default_minimum_abundances) <- c("CB", "PB", "SB") 
```


# Test results

## One strain per functional group

Constructing parameter set.

```{r}
one_strain_paramameter <- new_strain_parameter()
# one_strain_initial_state <- one_strain_paramameter$initial_state
```


```{r eval = run_steadystate_sims}
simulation_result1 <- run_simulation(
  parameter_values = one_strain_paramameter,
  initial_state = one_strain_paramameter$initial_state
)
save(simulation_result1, file = "data/multistrain1.Rda")
```


```{r}
load(file = "data/multistrain1.Rda")
plot_dynamics_strains(simulation_result1)
```



## Three strains per functional group

```{r}
multi_strain_paramameter <- new_strain_parameter(n_CB = 3, n_PB = 3, n_SB = 3)

multi_strain_initial_state <- new_initial_state_anoxic(n_CB = 3, n_PB = 3, n_SB = 3, values = "NA")

multi_strain_initial_state["CB_1"] <- 5e3
multi_strain_initial_state["CB_2"] <- 1e3
multi_strain_initial_state["CB_3"] <- 0
multi_strain_initial_state["PB_1"] <- 1e7
multi_strain_initial_state["PB_2"] <- 1e6
multi_strain_initial_state["PB_3"] <- 1e5
multi_strain_initial_state["SB_1"] <- 1e7
multi_strain_initial_state["SB_2"] <- 1e6
multi_strain_initial_state["SB_3"] <- 1e5
multi_strain_initial_state["SO"] <- 300
multi_strain_initial_state["SR"] <- 300
multi_strain_initial_state["O"] <- 1e1
multi_strain_initial_state["P"] <- 1e1

multi_strain_paramameter$initial_state <- multi_strain_initial_state

rm(multi_strain_initial_state)
```


```{r eval = run_steadystate_sims}
simulation_result3 <- run_simulation(
  parameter_values = multi_strain_paramameter,
  initial_state = multi_strain_paramameter$initial_state
)
save(simulation_result3, file = "data/multistrain3.Rda")
```


```{r}
load(file = "data/multistrain3.Rda")
plot_dynamics_strains(simulation_result3)
```

