---
title: "Partial reproduction of Bush et al (2017) Oxic-anoxic regime shifts mediated by feedbacks between biogeochemical processes and microbial community dynamics"
author: "Owen Petchey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmarkdown::html_vignette:
    toc: yes
vignette: >
  %\VignetteIndexEntry{Reproducing some results of Bush et al 2017}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, output = FALSE, message = FALSE, echo = FALSE}

knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE,
                      fig.align = "centre", 
                      fig.width = 7, 
                      fig.height = 4)


```

# Introduction

The aims here are:

-   Reproduce the results of [Bush et al 2017](https://www.nature.com/articles/s41467-017-00912-x).

And in addition:

-   Show how temporal change in oxygen diffusivity causes temporal switches between oxic and anoxic states.
-   Show how differences in the functional groups composition alters the ecosystem response to variation in oxygen diffusivity.
-   Quantify the amount of hysteresis and nonlinearity in these responses.
-   Show how amount of hysteresis and nonlinearity in ecosystem response depends on functional group composition.

These additional results are only presented graphically below, and are not discussed. They will be presented and discussed in an article associated with this package (*link to be added*).

Please see the User Guide vignette for further introduction and general methods.

The only difference from the published model (Bush et al 2017) is that here the populations of the organisms are not allowed to decrease below a minimum abundance (see below for the exact implementation).

## Code availability

Much of the code used to create the content of this vignette is not shown. It is available in the [microxanox github repository](https://github.com/opetchey/microxanox/blob/main/vignettes/partial-reproduction-Bushetal2017.Rmd)

# Methods

## Setup R

```{r}
library(tidyverse)
library(deSolve)
library(rootSolve)
library(here)
if (!require(microxanox)) {
  devtools::load_all(here::here())
}
library(patchwork)

## Set random number generator seed
## Is redundant if there are no stochastic components in the model
set.seed(13)

## should some of the more intense simulations be run...
run_steadystate_sims <- FALSE
```


## Set defaults

```{r}
default_dynamic_model <- bushplus_dynamic_model
default_parameter_values <- new_starter()
## no default_initial_state
default_sim_duration <- 2000
default_sim_sample_interval <- 1
default_log10a_series <- c(log10(default_parameter_values$a_O),
                           log10(default_parameter_values$a_O))
default_event_definition <- event_definition_1
default_event_interval <- 10
default_noise_sigma <- 0
default_minimum_abundances <- rep(1e2, 3)
names(default_minimum_abundances) <- c("CB", "PB", "SB") 
```

# Results

## Initial conditions favouring anoxic, no noise, no forcing

Reproduce dynamics when the initial conditions favour the anoxic state (Figure 2a, b in Bush et al. 2017)

```{r}

sim_res <- run_simulation(initial_state = new_initial_state(values = "bush_anoxic"))
plot_dynamics(simulation_result = sim_res)

```

Population dynamics seem as in the paper. Resource dynamics fluctuate more than in the paper.

## Initial conditions favouring oxic, no noise, no forcing

Reproduce dynamics when the initial conditions favour the oxic state (Figure 2c, d in Bush et al. 2017)

```{r}

sim_res <- run_simulation(initial_state = new_initial_state(values = "bush_oxic"))

plot_dynamics(sim_res)
##ggsave("high_CB.png")
```

## Stable states

Here we find the stable states that correspond to specific values of oxygen diffusivity (parameter $a_0$ / `a_0`). (Code not displayed.)

```{r echo = FALSE, sim_ss_CB_SB_PB1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_CB_SB_PB.Rds")}
ssfind_minimum_abundances <- rep(0, 3)
names(ssfind_minimum_abundances) <- c("CB", "PB", "SB") 
ssfind_simulation_duration <- 10000
ssfind_simulation_sampling_interval <- ssfind_simulation_duration
ssfind_event_interval <- ssfind_simulation_duration
ssfind_parameters <- default_parameter_values
grid_num_a <- 100
a_Os <- 10^seq(-4.5, -1.5, length=grid_num_a)
grid_num_N <- 2
initial_CBs <- 10^seq(0, 8, length=grid_num_N)
initial_PBs <- 1e5
initial_SBs <- 1e5
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)

ss_CB_SB_PB <- ss_by_a_N(expt, default_parameter_values)
```


```{r echo=FALSE, sim_ss_CB_SB_PB11, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_CB_SB_PB.Rds")}
saveRDS(ss_CB_SB_PB, file = "data/partial_reproduction/ss_CB_SB_PB.RDS")
```

```{r echo = FALSE}
ss_CB_SB_PB <- readRDS(file = "data/partial_reproduction/ss_CB_SB_PB.RDS")
```


```{r echo = FALSE}
p1 <- ss_CB_SB_PB %>%
  select(a,
         starts_with("CB"),
         starts_with("PB"),
         starts_with("SB"))  %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species),
            size=0.8) +
  ylab(expression(Log[10](Abundance+1))) +
  xlab(expression(Log[10](Oxygen~diffusivity))) +
  ylim(0,10) +
  #theme(plot.title=element_text(size=10, hjust=0.5)) +
  labs(title="Organisms")  
##ggsave("figures/CB_SB_PB.png", width = 3, height = 2)

p2 <- ss_CB_SB_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species)) +
  labs(title="Substrates") 


p1 / p2

```

## Temporal state switching

### Anoxic-oxic-anoxic

Temporal change in oxygen diffusivity is used to switch the system from anoxic to oxic and back to anoxic.

```{r sim_lhl_with_defaults, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/lhl_with_defaults.RDS")}
simulation_duration <- 5000
simulation_sampling_interval <- 10
event_interval_t <- 100

## low-high-low oxgygen diffusivity 
lhl_log10a_series <- c(-8, -8, -2, -2, -2, -2, -2, -8, -8)


## run simulation
sim_res <- run_simulation(dynamic_model = bushplus_dynamic_model,
                          initial_state = new_initial_state(values = "bush_anoxic"),
                          log10a_series = lhl_log10a_series,
                          sim_duration = simulation_duration,
                          sim_sample_interval = simulation_sampling_interval,
                          event_interval = event_interval_t)
```


```{r echo = FALSE, sim_lhl_with_defaults1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/lhl_with_defaults.RDS")}
saveRDS(sim_res, "data/partial_reproduction/lhl_with_defaults.RDS")
```



```{r echo = FALSE}
lhl_with_defaults <- readRDS("data/partial_reproduction/lhl_with_defaults.RDS")
```


```{r}
plot_dynamics(lhl_with_defaults)
```

```{r eval = FALSE, echo = FALSE}
lhl_with_defaults$result %>%
  dplyr::filter(between(time, 1000, 73000)) %>%
  ggplot() +
  geom_path(aes(x=a, y=log10(O)),
            arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))
```

### Oxic-anoxic-oxic

Temporal change in oxygen diffusivity is used to switch the system from oxic to anoxic and back to oxic.



```{r sim_hlh_with_defaults, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/hlh_with_defaults.RDS")}

simulation_duration <- 50000

## low-high-low oxgygen diffusivity 
hlh_log10a_series <- c(-2, -2, -10, -14, -18, -22, -2, -2, -2)

## run simulation
sim_res <- run_simulation(dynamic_model = bushplus_dynamic_model,
                          initial_state = new_initial_state(values = "bush_oxic"), # init_state_favouring_oxic,
                          log10a_series = hlh_log10a_series,
                          sim_duration = simulation_duration,
                          sim_sample_interval = simulation_sampling_interval,
                          event_interval = event_interval_t)
```


```{r echo = FALSE, sim_hlh_with_defaults1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/hlh_with_defaults.RDS")}
saveRDS(sim_res, "data/partial_reproduction/hlh_with_defaults.RDS")
```

```{r echo = FALSE}
hlh_with_defaults <- readRDS("data/partial_reproduction/hlh_with_defaults.RDS")
```


```{r}
plot_dynamics(hlh_with_defaults)
```

```{r eval = FALSE, echo = FALSE}
hlh_with_defaults$result %>%
  dplyr::filter(between(time, 1000, 100000)) %>%
  ggplot() +
  geom_path(aes(x=a, y=log10(O)),
            arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))
```

## Functional group composition and nature of response

In this section we get the stable states corresponding to specific values of oxygen diffusivity (parameter $a_0$ / `a_0`), for each combination of presence/absence of the functional groups.

Here we set the conditions common to all simulations:

```{r}
ssfind_minimum_abundances <- rep(0, 3)
names(ssfind_minimum_abundances) <- c("CB", "PB", "SB") 
ssfind_simulation_duration <- 10000
ssfind_simulation_sampling_interval <- ssfind_simulation_duration
ssfind_event_interval <- ssfind_simulation_duration
ssfind_parameters <- default_parameter_values
# ssfind_init_state <- c(N_CB = NA, 
#                        N_PB = NA,
#                        N_SB = NA,
#                        SO = 500,
#                        SR = 50,
#                        O = 30,
#                        P = 10)
##ssfind_init_state <- default_initial_state
##ssfind_init_state <- return_anoxic_1strain_initial_state()
ssfind_init_state <- c(N_CB = NA, #this one is varied
                       N_PB = 1e8,
                       N_SB = 1e8,
                       SO = 200,
                       SR = 200,
                       O = 10,
                       P = 9.5)
grid_num_a <- 100
a_Os <- 10^seq(-4.5, -1.5, length=grid_num_a)
grid_num_N <- 2
```


### No organisms

```{r sim_ss_no_biology, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_no_biology.RDS")}
initial_CBs <- 0
initial_PBs <- 0
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
ss_no_biology <- ss_by_a_N(expt, default_parameter_values)
```


```{r echo = FALSE, sim_ss_no_biology1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_no_biology.RDS")}
saveRDS(ss_no_biology, "data/partial_reproduction/ss_no_biology.RDS")
```

```{r echo = FALSE}
ss_no_biology <- readRDS("data/partial_reproduction/ss_no_biology.RDS")
```

```{r echo = FALSE}
ss_no_biology %>%
  select(a,
         starts_with("CB"),
         starts_with("PB"),
         starts_with("SB")) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

```{r echo = FALSE}
ss_no_biology %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

### CB

```{r sim_ss_only_CB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_CB.RDS")}
initial_CBs <- 10^seq(0, 8, length=grid_num_N)
initial_PBs <- 0
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
ss_only_CB <- ss_by_a_N(expt, default_parameter_values)
```


```{r  echo = FALSE, sim_ss_only_CB1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_CB.RDS")}
saveRDS(ss_only_CB, "data/partial_reproduction/ss_only_CB.RDS")
```

```{r echo = FALSE}
ss_only_CB <- readRDS("data/partial_reproduction/ss_only_CB.RDS")
```

```{r echo = FALSE}
tempx1 <- ss_only_CB %>%
  select(a,
         starts_with("CB"),
         starts_with("PB"),
         starts_with("SB")) %>%
  gather(key = Species, value=Quantity, 2:ncol(.))

tempx1 %>%
  ggplot(aes(x = a, y = log10(Quantity +1), col = Species)) +
  geom_path(size=0.8) +
  ylab(expression(Log[10](Abundance+1))) +
  xlab(expression(Log[10](Oxygen~diffusivity))) +
  theme_light() +
  ylim(0,10) +
  #geom_path(data = filter(tempx1, Species == "PB"),
  #          aes(y=0.2), size = 0.8) +
  theme(plot.title=element_text(size=10, hjust=0.5)) +
  labs(title="Only CB") 

##ggsave("figures/CB.png", width = 3, height = 2)
```

```{r echo = FALSE}
ss_only_CB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

### SB

```{r sim_ss_only_SB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_SB.RDS")}
initial_CBs <- 0  # this one is varied
initial_PBs <- 0
initial_SBs <- 10^seq(0, 8, length=grid_num_N)
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
ss_only_SB <- ss_by_a_N(expt, default_parameter_values)
```


```{r  echo = FALSE, sim_ss_only_SB1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_SB.RDS")}
saveRDS(ss_only_SB, "data/partial_reproduction/ss_only_SB.RDS")
```

```{r echo = FALSE}
ss_only_SB <- readRDS("data/partial_reproduction/ss_only_SB.RDS")
```

```{r echo = FALSE}
ss_only_SB %>%
  select(a,
         starts_with("CB"),
         starts_with("PB"),
         starts_with("SB")) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

```{r echo = FALSE}
ss_only_SB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

### PB

```{r sim_ss_only_PB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_PB.RDS")}
initial_CBs <- 0  # this one is varied
initial_PBs <- 10^seq(0, 8, length=grid_num_N)
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
ss_only_PB <- ss_by_a_N(expt, default_parameter_values)
```


```{r  echo = FALSE, sim_ss_only_PB1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_PB.RDS")}
saveRDS(ss_only_PB, "data/partial_reproduction/ss_only_PB.RDS")
```

```{r echo = FALSE}
ss_only_PB <- readRDS("data/partial_reproduction/ss_only_PB.RDS")
```

```{r echo = FALSE}
tempx1 <- ss_only_PB %>%
  select(a,
         starts_with("CB"),
         starts_with("PB"),
         starts_with("SB")) %>%
  gather(key = Species, value=Quantity, 2:ncol(.))
tempx1 %>%
  ggplot(aes(x = a, y = log10(Quantity+1), col = Species)) +
  geom_path(size = 0.8) +
  theme_light() +
  ylim(0,10) +
  ylab(expression(Log[10](Abundance))) +
  xlab(expression(Log[10](Oxygen~diffusivity))) +
  #geom_path(data = filter(tempx1, Species == "CB"),
  #          aes(y=0.2), size = 0.8)+
  #geom_path(data = filter(tempx1, Species == "PB"),
  #          size = 0.8) +
  theme(plot.title=element_text(size=10, hjust=0.5)) +
  labs(title="Only PB") 

##ggsave("figures/PB.png", width = 3, height = 2)

```

```{r echo = FALSE}
ss_only_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

### SB and PB

```{r sim_ss_only_SB_PB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_SB_PB.RDS")}
initial_CBs <- 0  # this one is varied
initial_PBs <- 10^seq(0, 8, length=grid_num_N)
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
expt$N_SB <- expt$N_PB
ss_only_SB_PB <- ss_by_a_N(expt, default_parameter_values)
```


```{r  echo = FALSE, sim_ss_only_SB_PB1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_SB_PB.RDS")}
saveRDS(ss_only_SB_PB, "data/partial_reproduction/ss_only_SB_PB.RDS")
```

```{r echo = FALSE}
ss_only_SB_PB <- readRDS("data/partial_reproduction/ss_only_SB_PB.RDS")
```

```{r echo = FALSE}
ss_only_SB_PB %>%
  select(a,
         starts_with("CB"),
         starts_with("PB"),
         starts_with("SB")) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

```{r echo = FALSE}
ss_only_SB_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

### SB and CB

```{r sim_ss_only_SB_CB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_SB_CB.RDS")}
initial_CBs <- 10^seq(0, 8, length=grid_num_N)
initial_PBs <- 0
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
expt$N_SB <- expt$N_CB
ss_only_SB_CB <- ss_by_a_N(expt, default_parameter_values)
```


```{r  echo = FALSE, sim_ss_only_SB_CB1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_SB_CB.RDS")}
saveRDS(ss_only_SB_CB, "data/partial_reproduction/ss_only_SB_CB.RDS")
```

```{r echo = FALSE}
ss_only_SB_CB <- readRDS("data/partial_reproduction/ss_only_SB_CB.RDS")
```

```{r echo = FALSE}
ss_only_SB_CB %>%
  select(a,
         starts_with("CB"),
         starts_with("PB"),
         starts_with("SB")) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

```{r echo = FALSE}
ss_only_SB_CB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:5) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

### CB and PB

```{r sim_ss_only_CB_PB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_CB_PB.RDS")}
initial_CBs <- 0  # this one is varied
initial_PBs <- 10^seq(0, 8, length=grid_num_N)
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
expt$N_CB <- expt$N_PB
ss_only_CB_PB <- ss_by_a_N(expt, default_parameter_values)
```


```{r  echo = FALSE, sim_ss_only_CB_PB1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_CB_PB.RDS")}
saveRDS(ss_only_CB_PB, "data/partial_reproduction/ss_only_CB_PB.RDS")
```

```{r  echo = FALSE, }
ss_only_CB_PB <- readRDS("data/partial_reproduction/ss_only_CB_PB.RDS")
```

```{r echo = FALSE}
ss_only_CB_PB %>%
  select(a,          
         starts_with("CB"),          
         starts_with("PB"),          
         starts_with("SB")) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

```{r echo = FALSE}
ss_only_CB_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

### CB, SB, and PB

```{r sim_ss_CB_SB_PB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_CB_SB_PB.RDS")}
initial_CBs <- 10^seq(0, 8, length=grid_num_N)
initial_PBs <- 1e5
initial_SBs <- 1e5
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
ss_CB_SB_PB <- ss_by_a_N(expt, default_parameter_values)
```


```{r  echo = FALSE, sim_ss_CB_SB_PB12, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_CB_SB_PB.RDS")}
saveRDS(ss_CB_SB_PB, "data/partial_reproduction/ss_CB_SB_PB.RDS")
```

```{r echo = FALSE}
ss_CB_SB_PB <- readRDS("data/partial_reproduction/ss_CB_SB_PB.RDS")
```

```{r echo = FALSE}
ss_CB_SB_PB %>%
  select(a,          
         starts_with("CB"),          
         starts_with("PB"),          
         starts_with("SB")) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))

# ss_CB_SB_PB %>%
#   select(a, CB=N_CB, SB=N_SB, PB=N_PB) %>%
#   gather(key = Species, value=Quantity, 2:ncol(.)) %>%
#   ggplot() +
#   geom_path(aes(x = a, y = log10(Quantity), col = Species),
#             size=0.8) +
#   ylab(expression(Log[10](Abundance))) +
#   xlab(expression(Log[10](Oxygen~diffusivity))) +
#   theme_light() +
#   ylim(0,10) +
#   theme(plot.title=element_text(size=10, hjust=0.5)) +
#   labs(title="CB, SB, & PB") 
##ggsave("figures/CB_SB_PB.png", width = 3, height = 2)

```

```{r echo = FALSE}
ss_CB_SB_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species))
```

## Stability measures

Note that here, "stability measures" quantify characteristics of the state-environment relationship (i.e. nonlinearity and hysteresis). The measures of non-linearity and hysteresis were used in [Garnier et al (2020) (link to online article)](https://onlinelibrary.wiley.com/doi/abs/10.1002/ece3.6294).

Not much code is shown because all is rather standard data wrangling. The unique work is done by the `get_stability_measures` function, which is demonstrated in the User Guide.

```{r echo = FALSE, sim_resp_summary, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/resp_summary.RDS")}
all_ss <- tibble(readRDS("data/partial_reproduction/ss_no_biology.RDS"),
                 composition = "No organisms") %>%
  bind_rows(tibble(readRDS("data/partial_reproduction/ss_only_CB.RDS"),
                   composition = "CB")) %>%
  bind_rows(tibble(readRDS("data/partial_reproduction/ss_only_SB.RDS"),
                   composition = "SB")) %>%
  bind_rows(tibble(readRDS("data/partial_reproduction/ss_only_PB.RDS"),
                   composition = "PB")) %>%
  bind_rows(tibble(readRDS("data/partial_reproduction/ss_only_SB_PB.RDS"),
                   composition = "SB-PB")) %>%
  bind_rows(tibble(readRDS("data/partial_reproduction/ss_only_SB_CB.RDS"),
                   composition = "SB-CB")) %>%
  bind_rows(tibble(readRDS("data/partial_reproduction/ss_only_CB_PB.RDS"),
                   composition = "CB-PB")) %>%
  bind_rows(tibble(readRDS("data/partial_reproduction/ss_CB_SB_PB.RDS"),
                   composition = "CB-SB-PB"))


stab_res <- all_ss %>%
  group_by(composition) %>%
  do(stab_measures = get_stability_measures(.)) %>%
  unnest(cols = c(stab_measures)) %>%
  mutate(composition = as.factor(composition),
         composition = fct_relevel(composition,
                                   "No organisms",
                                   "CB",
                                   "SB",
                                   "PB",
                                   "CB-PB",
                                   "SB-CB",
                                   "SB-PB",
                                   "CB-SB-PB"),
         num_func_groups = case_when(composition =="No organisms" ~ 0,
                                     composition == "CB" ~ 1,
                                     composition == "SB" ~ 1,
                                     composition == "PB" ~ 1,
                                     composition == "CB-PB" ~ 2,
                                     composition == "SB-CB" ~ 2,
                                     composition == "SB-PB" ~ 2,
                                     composition == "CB-SB-PB" ~ 3
         ),
         var_type = ifelse(str_sub(Species, 3, 3)=="_", "Organism", "Substrate")) %>%
  gather(key = "stab_measure", value = "value", 3:6)
saveRDS(stab_res, "data/partial_reproduction/stab_res.RDS")
```

```{r echo = FALSE, fig.height=8}
stab_res <- readRDS("data/partial_reproduction/stab_res.RDS")
stab_res %>%
  ggplot() +
  geom_point(aes(x = composition, y = value)) +
  facet_grid(Species ~ stab_measure, scales = "free") +
  coord_flip()

```

### Nonlinearity

This is the amount of non-linearity in the (steady) state-environment relationship. Here, the environment is oxygen diffusivity $a_0$ / `a_0`.

#### Organism nonlinearity

```{r echo = FALSE}
resp_summ1 <- stab_res %>%
  dplyr::filter(stab_measure %in% c("nl_down", "nl_up")) %>%
  group_by(composition, Species, num_func_groups, var_type) %>%
  summarise(ave_nl = mean(value))

resp_summ1 %>%
  ggplot() +
  geom_point(aes(composition, ave_nl)) +
  facet_wrap( ~ Species)+
  coord_flip()

```

#### Substrate nonlinearity

```{r echo = FALSE}
focus_on <- "Substrate"
ave_nl_substrate <- resp_summ1 %>%
  dplyr::filter(var_type == focus_on) %>%
  group_by(composition) %>%
  summarise(ave_ave_nl = mean(ave_nl))
ave_nl_substrate %>%
  ggplot() +
  geom_point(aes(composition, ave_ave_nl)) +
  ggtitle(paste("Nonlinearity in", focus_on, "response."))+
  coord_flip()
```

#### Average organism nonlinearity

```{r echo = FALSE}
focus_on <- "Organism"
ave_nl_organism <- resp_summ1 %>%
  dplyr::filter(var_type == focus_on) %>%
  group_by(composition) %>%
  summarise(ave_ave_nl = mean(ave_nl, na.rm = TRUE))
ave_nl_organism %>%
  ggplot() +
  geom_point(aes(composition, ave_ave_nl)) +
  ggtitle(paste("Nonlinearity in", focus_on, "response."))+
  coord_flip()
```

#### System nonlinearity

```{r echo = FALSE}
focus_on <- "System"
ave_nl_system <- resp_summ1 %>%
  group_by(composition) %>%
  summarise(ave_ave_nl = mean(ave_nl, na.rm = TRUE))
ave_nl_system %>%
  ggplot() +
  geom_point(aes(composition, ave_ave_nl)) +
  ggtitle(paste("Nonlinearity in", focus_on, "response."))+
  coord_flip()
##ggsave("figures/system_nonlinearity.png", width = 3, height = 2)

```

### Hysteresis

#### Substrate hysteresis

```{r echo = FALSE}
focus_on <- "Substrate"
resp_summ3 <- stab_res %>%
  dplyr::filter(stab_measure %in% c("hyst_tot", "hyst_range"),
                var_type == focus_on) %>%
  group_by(composition, num_func_groups, stab_measure, var_type) %>%
  summarise(ave_hyst = mean(value, na.rm = TRUE))

resp_summ3 %>%
  ggplot() +
  geom_point(aes(x = composition, y = ave_hyst)) +
  facet_wrap( ~ stab_measure, scales="free") +
  ggtitle(paste("Hysteresis in", focus_on, "response."))+
  coord_flip()

```

#### Organism hysteresis

```{r echo = FALSE}
focus_on <- "Organism"
resp_summ3 <- stab_res %>%
  dplyr::filter(stab_measure %in% c("hyst_tot", "hyst_range"),
                var_type == focus_on) %>%
  group_by(composition, num_func_groups, stab_measure, var_type) %>%
  summarise(ave_hyst = mean(value, na.rm = TRUE))

resp_summ3 %>%
  ggplot() +
  geom_point(aes(x = composition, y = ave_hyst)) +
  facet_wrap( ~ stab_measure, scales="free") +
  ggtitle(paste("Hysteresis in", focus_on, "response."))+
  coord_flip()

```

#### System hysteresis (separate)

```{r echo = FALSE}
resp_summ4 <- stab_res %>%
  dplyr::filter(stab_measure %in% c("hyst_tot", "hyst_range")) %>%
  group_by(stab_measure, composition) %>%
  summarise(mean_hyst = mean(value, na.rm = TRUE))

resp_summ4 %>%
  ggplot() +
  geom_point(aes(x = composition, y = mean_hyst)) +
  facet_wrap( ~ stab_measure) +
  ggtitle("Hysteresis in system response.")+
  coord_flip()

```

#### System hysteresis (combined)

```{r echo = FALSE}
resp_summ5 <- resp_summ4 %>%
  group_by(composition) %>%
  summarise(mean_mean_hyst = mean(mean_hyst))

resp_summ5 %>%
  ggplot() +
  geom_point(aes(x = composition, y = mean_mean_hyst)) +
  xlab("Functional groups present") +
  ylab("Amount of hysteresis") +
  ylim(0,2) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  coord_flip()
##ggsave("figures/composition_system_hysteresis.png", width = 2.5, height = 2.5)

```
