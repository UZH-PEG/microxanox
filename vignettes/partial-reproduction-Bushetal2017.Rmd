---
title: "Partial reproduction of Bush et al (2017) Oxic-anoxic regime shifts mediated by feedbacks between biogeochemical processes and microbial community dynamics"
author: "Owen Petchey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmarkdown::html_vignette:
    toc: yes
vignette: >
  %\VignetteIndexEntry{Reproducing some results of Bush et al 2017}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r setup, output = FALSE, message = FALSE}

knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE,
                      fig.align = "centre", 
                      fig.width = 7, 
                      fig.height = 7)

library(tidyverse)
library(deSolve)
library(rootSolve)
library(here)
if (!require(microxanox)) {
  devtools::load_all(here::here())
}
library(patchwork)

## Set random number generator seed
## Is redundant if there are no stochastic components in the model
set.seed(13)

## should some of the more intense simulations be run...
run_steadystate_sims <- FALSE
```


# Introduction

The aims here are:

* Reproduce the results of [Bush et al 2017](https://www.nature.com/articles/s41467-017-00912-x).
* Show how temporal change in oxygen diffusivity causes temporal switches between oxic and anoxic states.
* Show how differences in the functional groups composition alters the ecosystem response to variation in oxygen diffusivity.
* Quantify the amount of hysteresis and nonlinearity in these responses.
* Show how amount of hysteresis and nonlinearity in ecosystem response depends on functional group composition.

Please see the User Guide vignette for further introduction and general methods.

The only difference from the published model (Bush et al 2017) is that here the populations of the organisms are not allowed to decrease below a minimum abundance (see below for the exact implementation).

# Methods

## Set defaults

```{r}
default_dynamic_model <- bushplus_dynamic_model_strains
default_parameter_values <- new_strain_starter()
## no default_initial_state
default_sim_duration <- 2000
default_sim_sample_interval <- 1
default_log10a_series <- c(log10(default_parameter_values$a_O),
                           log10(default_parameter_values$a_O))
default_event_definition <- event_definition_1_strains
default_event_interval <- 10
default_noise_sigma <- 0
default_minimum_abundances <- rep(1e2, 3)
names(default_minimum_abundances) <- c("CB", "PB", "SB") 
```

# Results

## Initial conditions favouring anoxic, no noise, no forcing

Figure 2a, b in Bush et al.

```{r}

sim_res <- run_simulation(initial_state = new_initial_state(values = "bush_anoxic"))
plot_dynamics_strains(simulation_result = sim_res)
#ggsave('xxx.png')
```


Population dynamics seem as in the paper.
Resource dynamics fluctuate more than in the paper.



## Initial conditions favouring oxic, no noise, no forcing

Figure 2c, d in Bush et al.

```{r} 

sim_res <- run_simulation(initial_state = new_initial_state(values = "bush_oxic"))

plot_dynamics(sim_res)
##ggsave("high_CB.png")
```


########## Working to here



## Stable states


```{r sim_ss_CB_SB_PB1, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_CB_SB_PB.Rds")}
ssfind_minimum_abundances <- rep(0, 3)
names(ssfind_minimum_abundances) <- c("CB", "PB", "SB") 
ssfind_simulation_duration <- 10000
ssfind_simulation_sampling_interval <- ssfind_simulation_duration
ssfind_event_interval <- ssfind_simulation_duration
ssfind_parameters <- default_parameter_values
#ssfind_init_state <- c(N_CB = NA, #this one is varied
#           N_PB = 1e8,
#           N_SB = 1e8,
#           SO = 200,
#           SR = 200,
#           O = 10,
#           P = 9.5)
grid_num_a <- 10
a_Os <- 10^seq(-4.5, -1.5, length=grid_num_a)
grid_num_N <- 2
initial_CBs <- 10^seq(0, 8, length=grid_num_N)
initial_PBs <- 1e5
initial_SBs <- 1e5
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)

ss_CB_SB_PB <- ss_by_a_N(expt)
saveRDS(ss_CB_SB_PB, file = "data/partial_reproduction/ss_CB_SB_PB.RDS")
```


```{r}
ss_CB_SB_PB <- readRDS(file = "data/partial_reproduction/ss_CB_SB_PB.RDS")
p1 <- ss_CB_SB_PB %>%
  select(a,
         starts_with("CB"),
         starts_with("PB"),
         starts_with("SB"))  %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity+1), col = Species),
            size=0.8) +
  ylab(expression(Log[10](Abundance+1))) +
  xlab(expression(Log[10](Oxygen~diffusivity))) +
  ylim(0,10) +
  #theme(plot.title=element_text(size=10, hjust=0.5)) +
  labs(title="Organisms")  
##ggsave("figures/CB_SB_PB.png", width = 3, height = 2)

p2 <- ss_CB_SB_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species)) +
  labs(title="Substrates") 


p1 / p2

```




## Temporal state switching

### Anoxic-oxic-anoxic

```{r sim_lhl_with_defaults, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/lhl_with_defaults.RDS")}

## simulation timing
simulation_duration <- 5000
simulation_sampling_interval <- 10
event_interval_t <- 100

## low-high-low oxgygen diffusivity 
lhl_log10a_series <- c(-8, -8, -2, -2, -2, -2, -2, -8, -8)


## run simulation
sim_res <- run_simulation(dynamic_model = bushplus_dynamic_model_strains,
                          initial_state = new_initial_state(values = "bush_anoxic"),
                          log10a_series = lhl_log10a_series,
                          sim_duration = simulation_duration,
                          sim_sample_interval = simulation_sampling_interval,
                          event_interval = event_interval_t)
saveRDS(sim_res, "data/partial_reproduction/lhl_with_defaults.RDS")
```

```{r}
lhl_with_defaults <- readRDS("data/partial_reproduction/lhl_with_defaults.RDS")
plot_dynamics(lhl_with_defaults)
```


```{r}
lhl_with_defaults$result %>%
  dplyr::filter(between(time, 1000, 73000)) %>%
  ggplot() +
  geom_path(aes(x=a, y=log10(O)),
            arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))
```


### Oxic-anoxic-oxic


```{r sim_hlh_with_defaults, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/hlh_with_defaults.RDS")}
## anoxic initial state
## init_state <- init_state_favouring_oxic

## simulation timing
simulation_duration <- 50000
simulation_sampling_interval <- 10
event_interval_t <- 100

## low-high-low oxgygen diffusivity 
hlh_log10a_series <- c(-2, -2, -10, -14, -18, -22, -2, -2, -2)



## run simulation
sim_res <- run_simulation(dynamic_model = bushplus_dynamic_model_strains,
                          initial_state = new_initial_state(values = "bush_oxic"), # init_state_favouring_oxic,
                          log10a_series = hlh_log10a_series,
                          sim_duration = simulation_duration,
                          sim_sample_interval = simulation_sampling_interval,
                          event_interval = event_interval_t)
saveRDS(sim_res, "data/partial_reproduction/hlh_with_defaults.RDS")
```

```{r}
hlh_with_defaults <- readRDS("data/partial_reproduction/hlh_with_defaults.RDS")
plot_dynamics(hlh_with_defaults)
```


```{r}
hlh_with_defaults$result %>%
  dplyr::filter(between(time, 1000, 100000)) %>%
  ggplot() +
  geom_path(aes(x=a, y=log10(O)),
            arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))
```


## Functional group composition and nature of response


```{r}
ssfind_minimum_abundances <- rep(0, 3)
names(ssfind_minimum_abundances) <- c("CB", "PB", "SB") 
ssfind_simulation_duration <- 10000
ssfind_simulation_sampling_interval <- ssfind_simulation_duration
ssfind_event_interval <- ssfind_simulation_duration
ssfind_parameters <- default_parameter_values
# ssfind_init_state <- c(N_CB = NA, 
#                        N_PB = NA,
#                        N_SB = NA,
#                        SO = 500,
#                        SR = 50,
#                        O = 30,
#                        P = 10)
##ssfind_init_state <- default_initial_state
##ssfind_init_state <- return_anoxic_1strain_initial_state()
ssfind_init_state <- c(N_CB = NA, #this one is varied
           N_PB = 1e8,
           N_SB = 1e8,
           SO = 200,
           SR = 200,
           O = 10,
           P = 9.5)
grid_num_a <- 100
a_Os <- 10^seq(-4.5, -1.5, length=grid_num_a)
grid_num_N <- 2
```

### Each composition

#### No organisms


```{r sim_ss_no_biology, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_no_biology.RDS")}

initial_CBs <- 0
initial_PBs <- 0
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)


ss_no_biology <- ss_by_a_N(expt)
saveRDS(ss_no_biology, "data/partial_reproduction/ss_no_biology.RDS")
```

```{r}
ss_no_biology <- readRDS("data/partial_reproduction/ss_no_biology.RDS")
```

```{r}
ss_no_biology %>%
  select(a, N_CB, N_SB, N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


```{r}
ss_no_biology %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```




#### CB

```{r sim_ss_only_CB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_CB.RDS")}



initial_CBs <- 10^seq(0, 8, length=grid_num_N)
initial_PBs <- 0
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)


ss_only_CB <- ss_by_a_N(expt)
saveRDS(ss_only_CB, "data/partial_reproduction/ss_only_CB.RDS")
```

```{r}
ss_only_CB <- readRDS("data/partial_reproduction/ss_only_CB.RDS")
```

```{r}
tempx1 <- ss_only_CB %>%
  select(a, CB=N_CB, SB=N_SB, PB=N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.))
tempx1 %>%
  ggplot(aes(x = a, y = log10(Quantity), col = Species)) +
  geom_path(size=0.8) +
  ylab(expression(Log[10](Abundance))) +
  xlab(expression(Log[10](Oxygen~diffusivity))) +
  theme_light() +
  ylim(0,10) +
  geom_path(data = filter(tempx1, Species == "PB"),
            aes(y=0.2), size = 0.8) +
  theme(plot.title=element_text(size=10, hjust=0.5)) +
  labs(title="Only CB") 
  
##ggsave("figures/CB.png", width = 3, height = 2)
```

```{r}
ss_only_CB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```

#### SB

```{r sim_ss_only_SB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_SB.RDS")}


initial_CBs <- 0  # this one is varied
initial_PBs <- 0
initial_SBs <- 10^seq(0, 8, length=grid_num_N)
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)


ss_only_SB <- ss_by_a_N(expt)

saveRDS(ss_only_SB, "data/partial_reproduction/ss_only_SB.RDS")
```

```{r}
ss_only_SB <- readRDS("data/partial_reproduction/ss_only_SB.RDS")
```


```{r}
ss_only_SB %>%
  select(a, N_CB, N_SB, N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```

```{r}
ss_only_SB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```

#### PB

```{r sim_ss_only_PB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_PB.RDS")}



initial_CBs <- 0  # this one is varied
initial_PBs <- 10^seq(0, 8, length=grid_num_N)
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)


ss_only_PB <- ss_by_a_N(expt)

saveRDS(ss_only_PB, "data/partial_reproduction/ss_only_PB.RDS")
```

```{r}
ss_only_PB <- readRDS("data/partial_reproduction/ss_only_PB.RDS")
```


```{r}
tempx1 <- ss_only_PB %>%
  select(a, CB=N_CB, SB=N_SB, PB=N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.))
tempx1 %>%
  ggplot(aes(x = a, y = log10(Quantity), col = Species)) +
  geom_path(size = 0.8) +
  theme_light() +
  ylim(0,10) +
  ylab(expression(Log[10](Abundance))) +
  xlab(expression(Log[10](Oxygen~diffusivity))) +
  geom_path(data = filter(tempx1, Species == "CB"),
            aes(y=0.2), size = 0.8)+
  geom_path(data = filter(tempx1, Species == "PB"),
            size = 0.8) +
  theme(plot.title=element_text(size=10, hjust=0.5)) +
  labs(title="Only PB") 

##ggsave("figures/PB.png", width = 3, height = 2)

```

```{r}
ss_only_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


#### SB and PB


```{r sim_ss_only_SB_PB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_SB_PB.RDS")}


initial_CBs <- 0  # this one is varied
initial_PBs <- 10^seq(0, 8, length=grid_num_N)
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
expt$N_SB <- expt$N_PB

ss_only_SB_PB <- ss_by_a_N(expt)
saveRDS(ss_only_SB_PB, "data/partial_reproduction/ss_only_SB_PB.RDS")
```

```{r}
ss_only_SB_PB <- readRDS("data/partial_reproduction/ss_only_SB_PB.RDS")
```

```{r}
ss_only_SB_PB %>%
  select(a, N_CB, N_SB, N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


```{r}
ss_only_SB_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```

#### SB and CB


```{r sim_ss_only_SB_CB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_SB_CB.RDS")}


initial_CBs <- 10^seq(0, 8, length=grid_num_N)
initial_PBs <- 0
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
expt$N_SB <- expt$N_CB

ss_only_SB_CB <- ss_by_a_N(expt)
saveRDS(ss_only_SB_CB, "data/partial_reproduction/ss_only_SB_CB.RDS")
```

```{r}
ss_only_SB_CB <- readRDS("data/partial_reproduction/ss_only_SB_CB.RDS")
```

```{r}
ss_only_SB_CB %>%
  select(a, N_CB, N_SB, N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


```{r}
ss_only_SB_CB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:5) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```

#### CB and PB


```{r sim_ss_only_CB_PB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_only_CB_PB.RDS")}


initial_CBs <- 0  # this one is varied
initial_PBs <- 10^seq(0, 8, length=grid_num_N)
initial_SBs <- 0
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)
expt$N_CB <- expt$N_PB

ss_only_CB_PB <- ss_by_a_N(expt)
saveRDS(ss_only_CB_PB, "data/partial_reproduction/ss_only_CB_PB.RDS")
```

```{r}
ss_only_CB_PB <- readRDS("data/partial_reproduction/ss_only_CB_PB.RDS")
```

```{r}
ss_only_CB_PB %>%
  select(a, N_CB, N_SB, N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


```{r}
ss_only_SB_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


#### CB, SB, and PB


```{r sim_ss_CB_SB_PB, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/ss_CB_SB_PB.RDS")}


initial_CBs <- 10^seq(0, 8, length=grid_num_N)
initial_PBs <- 1e5
initial_SBs <- 1e5
expt <- expand.grid(N_CB = initial_CBs,
                    N_PB = initial_PBs,
                    N_SB = initial_SBs,
                    a_O = a_Os)

ss_CB_SB_PB <- ss_by_a_N(expt)
saveRDS(ss_CB_SB_PB, "data/partial_reproduction/ss_CB_SB_PB.RDS")
```

```{r}
ss_CB_SB_PB <- readRDS("data/partial_reproduction/ss_CB_SB_PB.RDS")
```


```{r}
ss_CB_SB_PB %>%
  select(a, CB=N_CB, SB=N_SB, PB=N_PB) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species),
            size=0.8) +
  ylab(expression(Log[10](Abundance))) +
  xlab(expression(Log[10](Oxygen~diffusivity))) +
  theme_light() +
  ylim(0,10) +
  theme(plot.title=element_text(size=10, hjust=0.5)) +
  labs(title="CB, SB, & PB") 
##ggsave("figures/CB_SB_PB.png", width = 3, height = 2)

```


```{r}
ss_CB_SB_PB %>%
  select(a, SO, SR, O, P) %>%
  gather(key = Species, value=Quantity, 2:ncol(.)) %>%
  ggplot() +
  geom_path(aes(x = a, y = log10(Quantity), col = Species))
```


### All response measures

```{r sim_resp_summary, eval = run_steadystate_sims | !file.exists("data/partial_reproduction/resp_summary.RDS")}
all_ss <- bind_cols(readRDS("data/partial_reproduction/ss_no_biology.RDS"),
                    composition = rep("No organisms", grid_num_a*grid_num_N),
                    direction = c(rep("up", grid_num_a),
                                  rep("down", grid_num_a)))
all_ss <- bind_rows(all_ss,
                    bind_cols(readRDS("data/partial_reproduction/ss_only_CB.RDS"),
                              composition = rep("CB", grid_num_a*grid_num_N),
                              direction = c(rep("up", grid_num_a),
                                            rep("down", grid_num_a))))
all_ss <- bind_rows(all_ss,
                    bind_cols(readRDS("data/partial_reproduction/ss_only_SB.RDS"),
                              composition = rep("SB", grid_num_a*grid_num_N),
                              direction = c(rep("up", grid_num_a),
                                            rep("down", grid_num_a))))
all_ss <- bind_rows(all_ss,
                    bind_cols(readRDS("data/partial_reproduction/ss_only_PB.RDS"),
                              composition = rep("PB", grid_num_a*grid_num_N),
                              direction = c(rep("up", grid_num_a),
                                            rep("down", grid_num_a))))
all_ss <- bind_rows(all_ss,
                    bind_cols(readRDS("data/partial_reproduction/ss_only_SB_PB.RDS"),
                              composition = rep("SB-PB", grid_num_a*grid_num_N),
                              direction = c(rep("up", grid_num_a),
                                            rep("down", grid_num_a))))
all_ss <- bind_rows(all_ss,
                    bind_cols(readRDS("data/partial_reproduction/ss_only_SB_CB.RDS"),
                              composition = rep("SB-CB", grid_num_a*grid_num_N),
                              direction = c(rep("up", grid_num_a),
                                            rep("down", grid_num_a))))
all_ss <- bind_rows(all_ss,
                    bind_cols(readRDS("data/partial_reproduction/ss_only_CB_PB.RDS"),
                              composition = rep("CB-PB", grid_num_a*grid_num_N),
                              direction = c(rep("up", grid_num_a),
                                            rep("down", grid_num_a))))
all_ss <- bind_rows(all_ss,
                    bind_cols(readRDS("data/partial_reproduction/ss_CB_SB_PB.RDS"),
                              composition = rep("CB-SB-PB",
                                                grid_num_a*grid_num_N),
                              direction = c(rep("up", grid_num_a),
                                            rep("down", grid_num_a))))


x_long <- all_ss %>%
  gather(key = Species, value = Quantity, 2:8)
x_wide <- x_long %>%
  select(-initial_N_CB) %>%
  spread(key = direction, value=Quantity, drop=T)

resp_summary <- x_wide %>%
  group_by(composition, Species) %>%
  summarise(hyst_1 = mean(abs(log10(up) - log10(down))),
            hyst_2 = get_hysteresis_range(up, down, a),
            nl_up = get_nonlinearity(a, log10(up)),
            nl_down = get_nonlinearity(a, log10(down))) %>%
  ungroup() %>%
  gather(key = resp_measure, value = value, 3:6) %>%
  mutate(composition = fct_relevel(composition,
                                   "No organisms",
                                   "CB",
                                   "SB",
                                   "PB",
                                   "CB-PB",
                                   "SB-CB",
                                   "SB-PB",
                                   "CB-SB-PB"),
         num_func_groups = case_when(composition =="No organisms" ~ 0,
                                     composition == "CB" ~ 1,
                                     composition == "SB" ~ 1,
                                     composition == "PB" ~ 1,
                                     composition == "CB-PB" ~ 2,
                                     composition == "SB-CB" ~ 2,
                                     composition == "SB-PB" ~ 2,
                                     composition == "CB-SB-PB" ~ 3
                                     ),
         var_type = ifelse(str_sub(Species, 1, 1)=="N", "Organism", "Substrate")
         )
saveRDS(resp_summary, "data/partial_reproduction/resp_summary.RDS")
```


```{r}
resp_summary <- readRDS("data/partial_reproduction/resp_summary.RDS")
resp_summary %>%
  ggplot() +
  geom_point(aes(x = composition, y = value)) +
  facet_grid(Species ~ resp_measure, scales = "free") +
  coord_flip()

```

### Nonlinearity

#### All species nonlinearity 

```{r}
resp_summ1 <- resp_summary %>%
  dplyr::filter(resp_measure %in% c("nl_down", "nl_up")) %>%
  group_by(composition, Species, num_func_groups, var_type) %>%
  summarise(ave_nl = mean(value))

resp_summ1 %>%
  ggplot() +
  geom_point(aes(composition, ave_nl)) +
  facet_wrap( ~ Species)

```

#### Substrate nonlinearity


```{r}
focus_on <- "Substrate"
ave_nl_substrate <- resp_summ1 %>%
  dplyr::filter(var_type == focus_on) %>%
  group_by(composition) %>%
  summarise(ave_ave_nl = mean(ave_nl))
ave_nl_substrate %>%
  ggplot() +
  geom_point(aes(composition, ave_ave_nl)) +
  ggtitle(paste("Nonlinearity in", focus_on, "response."))
```

#### Organism nonlinearity


```{r}
focus_on <- "Organism"
ave_nl_organism <- resp_summ1 %>%
  dplyr::filter(var_type == focus_on) %>%
  group_by(composition) %>%
  summarise(ave_ave_nl = sum(ave_nl)/unique(num_func_groups))
ave_nl_organism %>%
  ggplot() +
  geom_point(aes(composition, ave_ave_nl)) +
  ggtitle(paste("Nonlinearity in", focus_on, "response."))
```

#### System nonlinearity

```{r}
focus_on <- "System"
ave_nl_system <- resp_summ1 %>%
  group_by(composition) %>%
  summarise(ave_ave_nl = sum(ave_nl) / (unique(num_func_groups)+4))
ave_nl_system %>%
  ggplot() +
  geom_point(aes(composition, ave_ave_nl)) +
  ggtitle(paste("Nonlinearity in", focus_on, "response."))
##ggsave("figures/system_nonlinearity.png", width = 3, height = 2)

```

### Hysteresis

#### Substrate hysteresis 

```{r}
focus_on <- "Substrate"
resp_summ3 <- resp_summary %>%
  dplyr::filter(resp_measure %in% c("hyst_1", "hyst_2"),
         var_type == focus_on) %>%
  group_by(composition, num_func_groups, resp_measure, var_type) %>%
  summarise(ave_hyst = mean(value))

resp_summ3 %>%
  ggplot() +
  geom_point(aes(x = composition, y = ave_hyst)) +
  facet_wrap( ~ resp_measure, scales="free") +
  ggtitle(paste("Hysteresis in", focus_on, "response."))

```

#### Organism hysteresis 

```{r}
focus_on <- "Organism"
resp_summ3 <- resp_summary %>%
  dplyr::filter(resp_measure %in% c("hyst_1", "hyst_2"),
         var_type == focus_on) %>%
  group_by(composition, num_func_groups, resp_measure, var_type) %>%
  summarise(ave_hyst = sum(value) / unique(num_func_groups))

resp_summ3 %>%
  ggplot() +
  geom_point(aes(x = composition, y = ave_hyst)) +
  facet_wrap( ~ resp_measure, scales="free") +
  ggtitle(paste("Hysteresis in", focus_on, "response."))

```

#### System hysteresis (separate)

```{r}
resp_summ4 <- resp_summary %>%
  dplyr::filter(resp_measure %in% c("hyst_1", "hyst_2")) %>%
  group_by(resp_measure, composition) %>%
  summarise(mean_hyst = sum(value) / (unique(num_func_groups)+4))

resp_summ4 %>%
  ggplot() +
  geom_point(aes(x = composition, y = mean_hyst)) +
  facet_wrap( ~ resp_measure) +
  ggtitle("Hysteresis in system response.")

```

#### System hysteresis (combined)


```{r}
resp_summ5 <- resp_summ4 %>%
  group_by(composition) %>%
  summarise(mean_mean_hyst = mean(mean_hyst))

resp_summ5 %>%
  ggplot() +
  geom_point(aes(x = composition, y = mean_mean_hyst)) +
  xlab("Functional groups present") +
  ylab("Amount of hysteresis") +
  ylim(0,2) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
##ggsave("figures/composition_system_hysteresis.png", width = 2.5, height = 2.5)

```

